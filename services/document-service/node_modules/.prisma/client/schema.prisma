// Prisma Schema for AI Real-Time Content Collaboration Platform
// Generated from docs/09-database-contracts.md

generator client {
  provider   = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// TABLE: organizations
// Owner: Document Service (Write), Auth Service (Read)
// Description: Tenant isolation boundary.
// ============================================================================
model Organization {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name       String   @db.Text
  slug       String   @unique @db.Text
  created_at DateTime @default(now()) @db.Timestamptz
  updated_at DateTime @default(now()) @updatedAt @db.Timestamptz

  // Relations
  users    User[]
  projects Project[]
  members  OrganizationMember[]

  @@map("organizations")
}

// ============================================================================
// TABLE: users
// Owner: Auth Service
// Description: Identity and profile.
// ============================================================================
model User {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email           String   @unique @db.Text
  password_hash   String?  @db.Text
  full_name       String   @db.Text
  avatar_url      String?  @db.Text
  role            String   @default("viewer") @db.Text
  organization_id String   @db.Uuid
  created_at      DateTime @default(now()) @db.Timestamptz
  updated_at      DateTime @default(now()) @updatedAt @db.Timestamptz

  // Relations
  organization      Organization         @relation(fields: [organization_id], references: [id])
  projects_created  Project[]            @relation("ProjectCreatedBy")
  projects_owned    Project[]            @relation("ProjectOwner")
  documents_owned   Document[]           @relation("DocumentOwner")
  document_versions DocumentVersion[]    @relation("VersionCreatedBy")
  access_logs       AccessLog[]
  memberships       OrganizationMember[]
  team_memberships  TeamMember[]

  // Indexes
  @@index([organization_id])
  @@index([email])
  @@map("users")
}

model OrganizationMember {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organization_id String   @db.Uuid
  user_id         String   @db.Uuid
  role            String   @default("member") @db.Text
  joined_at       DateTime @default(now()) @db.Timestamptz

  organization Organization @relation(fields: [organization_id], references: [id])
  user         User         @relation(fields: [user_id], references: [id])

  @@unique([organization_id, user_id])
  @@map("organization_members")
}

// ============================================================================
// TABLE: projects
// Owner: Document Service
// Description: Logical grouping of documents (folders/workspaces).
// ============================================================================
model Project {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name            String   @db.Text
  description     String?  @db.Text
  organization_id String   @db.Uuid
  created_by      String   @db.Uuid
  owner_id        String   @db.Uuid
  created_at      DateTime @default(now()) @db.Timestamptz
  updated_at      DateTime @default(now()) @updatedAt @db.Timestamptz

  // Relations
  organization  Organization   @relation(fields: [organization_id], references: [id])
  creator       User           @relation("ProjectCreatedBy", fields: [created_by], references: [id])
  owner         User           @relation("ProjectOwner", fields: [owner_id], references: [id])
  documents     Document[]
  presentations Presentation[]
  canvas        Canvas[]
  team_members  TeamMember[]
  invitations   Invitation[]

  // Indexes
  @@index([organization_id])
  @@index([owner_id])
  @@map("projects")
}

// ============================================================================
// TABLE: documents
// Owner: Document Service (Metadata), Collaboration Service (Content)
// Description: The central resource.
// ============================================================================
model Document {
  id               String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title            String   @default("Untitled") @db.Text
  project_id       String   @db.Uuid
  owner_id         String   @db.Uuid
  yjs_binary_state Bytes    @default(dbgenerated("'\\x00'::bytea"))
  last_accessed_at DateTime @default(now()) @db.Timestamptz
  created_at       DateTime @default(now()) @db.Timestamptz
  updated_at       DateTime @default(now()) @updatedAt @db.Timestamptz

  // Relations
  project  Project           @relation(fields: [project_id], references: [id])
  owner    User              @relation("DocumentOwner", fields: [owner_id], references: [id])
  versions DocumentVersion[]

  // Indexes
  @@index([project_id])
  @@map("documents")
}

// ============================================================================
// TABLE: document_versions
// Owner: Document Service
// Description: Immutable history snapshots.
// NOTE: Rows MUST NEVER be updated - only created or deleted (pruned).
// ============================================================================
model DocumentVersion {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  document_id     String   @db.Uuid
  snapshot_binary Bytes
  created_by      String?  @db.Uuid
  name            String?  @db.Text
  created_at      DateTime @default(now()) @db.Timestamptz

  // Relations
  document Document @relation(fields: [document_id], references: [id])
  creator  User?    @relation("VersionCreatedBy", fields: [created_by], references: [id])

  // Indexes
  @@index([document_id])
  @@index([created_at])
  @@map("document_versions")
}

// ============================================================================
// TABLE: access_logs
// Owner: Auth Service / Security
// Description: Audit trail.
// ============================================================================
model AccessLog {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id       String   @db.Uuid
  resource_type String   @db.Text
  resource_id   String?  @db.Uuid
  action        String   @db.Text
  ip_address    String?  @db.Inet
  user_agent    String?  @db.Text
  created_at    DateTime @default(now()) @db.Timestamptz

  // Relations
  user User @relation(fields: [user_id], references: [id])

  // Indexes
  @@index([user_id])
  @@index([created_at])
  @@map("access_logs")
}

// ============================================================================
// TABLE: presentations
// Owner: Document Service
// Description: Presentations containing slides.
// ============================================================================
model Presentation {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  project_id String   @db.Uuid
  title      String   @db.Text
  template   String?  @db.Text
  created_at DateTime @default(now()) @db.Timestamptz
  updated_at DateTime @default(now()) @updatedAt @db.Timestamptz

  // Relations
  project Project @relation(fields: [project_id], references: [id])
  slides  Slide[]

  // Indexes
  @@index([project_id])
  @@map("presentations")
}

// ============================================================================
// TABLE: slides
// Owner: Document Service
// Description: Presentation slides for a project.
// ============================================================================
model Slide {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  presentation_id String   @db.Uuid
  title           String   @db.Text
  content         String   @db.Text
  order           Int      @default(0)
  created_at      DateTime @default(now()) @db.Timestamptz
  updated_at      DateTime @default(now()) @updatedAt @db.Timestamptz

  // Relations
  presentation Presentation @relation(fields: [presentation_id], references: [id])

  // Indexes
  @@index([presentation_id])
  @@map("slides")
}

// ============================================================================
// TABLE: canvas
// Owner: Document Service
// Description: Canvas data for projects.
// ============================================================================
model Canvas {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  project_id String   @db.Uuid
  data       Json     @default("{}")
  name       String   @default("Untitled Canvas") @db.Text
  created_at DateTime @default(now()) @db.Timestamptz
  updated_at DateTime @default(now()) @updatedAt @db.Timestamptz

  // Relations
  project Project @relation(fields: [project_id], references: [id])

  // Indexes
  @@index([project_id])
  @@map("canvas")
}

// ============================================================================
// TABLE: team_members
// Owner: Document Service
// Description: Project-level team members.
// ============================================================================
model TeamMember {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  project_id String   @db.Uuid
  user_id    String   @db.Uuid
  role       String   @default("viewer") @db.Text
  joined_at  DateTime @default(now()) @db.Timestamptz

  // Relations
  project Project @relation(fields: [project_id], references: [id])
  user    User    @relation(fields: [user_id], references: [id])

  // Indexes
  @@unique([project_id, user_id])
  @@index([project_id])
  @@index([user_id])
  @@map("team_members")
}

// ============================================================================
// TABLE: invitations
// Owner: Document Service
// Description: Pending email invitations for projects.
// ============================================================================
model Invitation {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  project_id String   @db.Uuid
  email      String   @db.Text
  role       String   @default("viewer") @db.Text
  token      String   @unique @db.Text
  expires_at DateTime @db.Timestamptz
  accepted   Boolean  @default(false)
  created_at DateTime @default(now()) @db.Timestamptz
  updated_at DateTime @default(now()) @updatedAt @db.Timestamptz

  // Relations
  project Project @relation(fields: [project_id], references: [id])

  // Indexes
  @@index([project_id])
  @@index([token])
  @@map("invitations")
}
