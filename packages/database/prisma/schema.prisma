// Prisma Schema for AI Real-Time Content Collaboration Platform
// Generated from docs/09-database-contracts.md

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}






// ============================================================================
// TABLE: organizations
// Owner: Document Service (Write), Auth Service (Read)
// Description: Tenant isolation boundary.
// ============================================================================
model Organization {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name       String   @db.Text
  slug       String   @unique @db.Text
  created_at DateTime @default(now()) @db.Timestamptz
  updated_at DateTime @default(now()) @updatedAt @db.Timestamptz

  // Relations
  users    User[]
  projects Project[]

  @@map("organizations")
}

// ============================================================================
// TABLE: users
// Owner: Auth Service
// Description: Identity and profile.
// ============================================================================
model User {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email           String   @unique @db.Text
  password_hash   String?  @db.Text
  full_name       String   @db.Text
  avatar_url      String?  @db.Text
  role            String   @default("viewer") @db.Text
  organization_id String   @db.Uuid
  created_at      DateTime @default(now()) @db.Timestamptz
  updated_at      DateTime @default(now()) @updatedAt @db.Timestamptz

  // Relations
  organization      Organization      @relation(fields: [organization_id], references: [id])
  projects_created  Project[]         @relation("ProjectCreatedBy")
  documents_owned   Document[]        @relation("DocumentOwner")
  document_versions DocumentVersion[] @relation("VersionCreatedBy")
  access_logs       AccessLog[]

  // Indexes
  @@index([organization_id])
  @@index([email])
  @@map("users")
}

// ============================================================================
// TABLE: projects
// Owner: Document Service
// Description: Logical grouping of documents (folders/workspaces).
// ============================================================================
model Project {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name            String   @db.Text
  description     String?  @db.Text
  organization_id String   @db.Uuid
  created_by      String   @db.Uuid
  created_at      DateTime @default(now()) @db.Timestamptz
  updated_at      DateTime @default(now()) @updatedAt @db.Timestamptz

  // Relations
  organization Organization @relation(fields: [organization_id], references: [id])
  creator      User         @relation("ProjectCreatedBy", fields: [created_by], references: [id])
  documents    Document[]

  // Indexes
  @@index([organization_id])
  @@map("projects")
}

// ============================================================================
// TABLE: documents
// Owner: Document Service (Metadata), Collaboration Service (Content)
// Description: The central resource.
// ============================================================================
model Document {
  id               String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title            String   @default("Untitled") @db.Text
  project_id       String   @db.Uuid
  owner_id         String   @db.Uuid
  yjs_binary_state Bytes    @default(dbgenerated("'\\x00'::bytea"))
  last_accessed_at DateTime @default(now()) @db.Timestamptz
  created_at       DateTime @default(now()) @db.Timestamptz
  updated_at       DateTime @default(now()) @updatedAt @db.Timestamptz

  // Relations
  project  Project           @relation(fields: [project_id], references: [id])
  owner    User              @relation("DocumentOwner", fields: [owner_id], references: [id])
  versions DocumentVersion[]

  // Indexes
  @@index([project_id])
  @@map("documents")
}

// ============================================================================
// TABLE: document_versions
// Owner: Document Service
// Description: Immutable history snapshots.
// NOTE: Rows MUST NEVER be updated - only created or deleted (pruned).
// ============================================================================
model DocumentVersion {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  document_id     String   @db.Uuid
  snapshot_binary Bytes
  created_by      String?  @db.Uuid
  name            String?  @db.Text
  created_at      DateTime @default(now()) @db.Timestamptz

  // Relations
  document Document @relation(fields: [document_id], references: [id])
  creator  User?    @relation("VersionCreatedBy", fields: [created_by], references: [id])

  // Indexes
  @@index([document_id])
  @@index([created_at])
  @@map("document_versions")
}

// ============================================================================
// TABLE: access_logs
// Owner: Auth Service / Security
// Description: Audit trail.
// ============================================================================
model AccessLog {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id       String   @db.Uuid
  resource_type String   @db.Text
  resource_id   String?  @db.Uuid
  action        String   @db.Text
  ip_address    String?  @db.Inet
  user_agent    String?  @db.Text
  created_at    DateTime @default(now()) @db.Timestamptz

  // Relations
  user User @relation(fields: [user_id], references: [id])

  // Indexes
  @@index([user_id])
  @@index([created_at])
  @@map("access_logs")
}
